# This is a basic workflow that is manually triggered

name: PR
run-name: PR Verification triggered by ${{ github.actor }}

env:
  COV_THRESHOLD: '70'

# Controls when the action will run.
on:
  pull_request:
    branches: [ 'main' ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  main:
    name: Verify PR
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Actions"
        uses: actions/checkout@v4
        with:
          # For security reasons, we only uses actions in "main" branch
          ref: ${{ github.event.repository.default_branch }}
          sparse-checkout: .github/actions
          path: .tmp
      - name: "Prepare"
        uses: ./.tmp/.github/actions/prepare
        with:
          branch: ${{ github.head_ref }}
      # Fetch base_ref for later use. We need to detect changed files and only consider test coverage on those files.
      - name: "Prepare PR Verification"
        id: prepare_pr
        uses: ./.tmp/.github/actions/prepare_pr
      - name: "PR Verification Facts"
        run: |
          echo ${{ toJSON(steps.prepare_pr.outputs)}}
      - name: "Test & Code Quality"
        uses: ./.tmp/.github/actions/verify
        with:
          coverpkg: './pkg/...,./test/...'
          fail_lint: 'true'
      - name: "Verify PR Test Coverage"
        shell: bash
        run: |
          go install github.com/PaloAltoNetworks/cov@3.2.0
          cov dist/coverage.out -b ${{ steps.prepare_pr.outputs.base_ref }} --report-path 'dist/pr-coverage.json' -t ${{ env.COV_THRESHOLD }} -e 1 --write-report
          
          
