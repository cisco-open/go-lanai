
## Build Container ##
FROM golang:1.16.3 AS builder
ARG PRIVATE_MODS
ARG VERSION
ARG BUILD_TIME
ARG BUILD_HASH
WORKDIR /go/src/
ADD . /go/src/
RUN mkdir -p -m 0600 ~/.ssh && \
    echo "StrictHostKeyChecking no " > /root/.ssh/config && \
    ssh-keyscan github.com >> ~/.ssh/known_hosts

# TODO fix this part with proper make targets and variables
RUN --mount=type=ssh \
    make init-once; \
    make clean build PRIVATE_MODS="$PRIVATE_MODS" VERSION="$VERSION" BUILD_TIME="$BUILD_TIME" BUILD_HASH="$BUILD_HASH"

#RUN --mount=type=ssh make init-once; \
#    go mod edit -dropreplace cto-github.cisco.com/NFV-BU/go-lanai; \
#    go get cto-github.cisco.com/NFV-BU/go-lanai@build; \
#    make clean init build

## Distribution Container ##
FROM buildpack-deps:buster-curl
EXPOSE {{- range $_, $elem := .Executables }} {{ if gt $elem.Port 0 }}{{ $elem.Port }} {{ end }} {{- end }}
WORKDIR /service/
COPY --from=builder /go/src/dist /service
{{- range $name, $elem := .Executables }}
    {{- if gt $elem.Port 0 }}
ENTRYPOINT ["/service/{{ $name }}"]
    {{- end }}
{{- end }}
