### Global Variables
.SECONDEXPANSION:

DESTDIR = dist
MODULE = {{ .Module.Path }}

EXECS = {{- range $key, $_ := .Executables }} {{ $key }} {{- end }}

GEN_LIST = \
	{{- range .Generates }}
	generate@{{ .Path }} \
	{{- end }}

RES_LIST = \
	{{- range .Resources }}
	resource@{{ .Output }} \
	{{- end }}

### Main
.PHONY: $(GEN_LIST) $(EXECS) $(RES_LIST)

## Required Variables by Local Targets
DOCKER ?= docker
SSHADD ?= ssh-add

# target patterns
pGenerate = generate@%
pResource = resource@%

## Local Targets
# Generate
$(GEN_LIST):
	$(GO) generate $(@:$(pGenerate)=%)

# Build
	{{- range $name, $elem := .Executables }}
{{ $name }}:
	$(GO) build -o $(DESTDIR)/$@ {{ $elem.Main }}
	{{ end }}

# Copy Resources
	{{- range .Resources }}
resource@{{ .Output }}:
	cp -rf {{ .Pattern }} $(DESTDIR)/{{ .Output }}
	{{ end }}
