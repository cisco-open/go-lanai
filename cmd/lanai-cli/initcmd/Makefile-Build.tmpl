.SECONDEXPANSION:
DOCKER = docker
SSHADD = ssh-add

DESTDIR = dist
MODULE = {{ .Module.Path }}

EXECS = {{- range $key, $_ := .Executables }} {{ $key }} {{- end }}

GEN_LIST = \
	{{- range .Generates }}
	generate@{{ .Path }} \
	{{- end }}

RES_LIST = \
	{{- range .Resources }}
	resource@{{ .Output }} \
	{{- end }}

# target patterns
pGenerate = generate@%
pResource = resource@%

# Main
.PHONY: $(GEN_LIST) $(EXECS) $(RES_LIST)

# Generate
$(GEN_LIST): init
	$(GO) generate $(@:$(pGenerate)=%)

# Build
	{{- range $name, $elem := .Executables }}
{{ $name }}:
	$(GO) build -o $(DESTDIR)/$@ {{ $elem.Main }}
	{{ end }}

# Copy Resources
	{{- range .Resources }}
resource@{{ .Output }}:
	cp -rf {{ .Pattern }} $(DESTDIR)/{{ .Output }}
	{{ end }}
