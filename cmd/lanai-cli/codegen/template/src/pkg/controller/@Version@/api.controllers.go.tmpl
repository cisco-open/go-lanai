{{- $rootData := . }}
{{- $pathName := index . "PathName" }}
{{- $pathData := index . "PathData" }}
{{- $version := index . "Version" }}
{{- $repository := index . "Repository" }}
// Package {{ $version }} Generated by lanai_cli codegen.
// Derived from contents in openapi contract, path: {{ $pathName }}
package {{ $version }}

import (
	"context"
	"cto-github.cisco.com/NFV-BU/go-lanai/pkg/web"
    "cto-github.cisco.com/NFV-BU/go-lanai/pkg/web/rest"
    {{- template "controllerImports" $rootData -}}
	"go.uber.org/fx"
)

{{- $nameFromPath := defaultNameFromPath $pathName }}
{{- $controllerName := concat $nameFromPath "Controller" | toTitle }}

{{- $diName := concat $nameFromPath "Controller" "DI" }}

type {{ $controllerName }} struct {}

type {{ $diName }} struct {
    fx.In
}

func New{{ $controllerName }}(di {{ $diName }}) web.Controller {
    return &{{$controllerName }}{}
}

{{ template "mappingFunction" args $rootData }}

{{ template "controllerFunctions" args . }}

{{ define "controllerImports" }}
    {{- $pathName := index . "PathName" | defaultNameFromPath }}
    {{- $pathData := index . "PathData" }}
    {{- $repository := index . "Repository" }}
    {{- $version := index . "Version" }}

    {{- $hasCommonImport := false }}
    {{- $hasAPIImport := false }}
    {{- range $opName, $opData := pathOperations $pathData }}
        {{- $operation := concat $pathName $opName | operation $opData }}

        {{- $requestStruct := $operation.RequestStruct structRegistry }}
        {{- if $requestStruct }}
            {{- if eq $requestStruct.Import "pkg/api"  }}
                {{- $hasCommonImport = true }}
            {{- else if $requestStruct.Import }}
                {{- $hasAPIImport = true }}
            {{- end }}
        {{- end }}

        {{- $responseStruct := $operation.ResponseStruct structRegistry }}
        {{- if $responseStruct }}
            {{- if eq $responseStruct.Import "pkg/api"  }}
                {{- $hasCommonImport = true }}
            {{- else if $responseStruct.Import }}
                {{- $hasAPIImport = true }}
            {{- end }}
        {{- end }}
    {{- end }}
    {{- template "ImportStruct" args $hasCommonImport $hasAPIImport . -}}
{{ end }}

{{ define "mappingFunction" }}
    {{- $rootData := index . 0 }}

    {{- $pathName := index $rootData "PathName" }}
    {{- $nameFromPath := defaultNameFromPath $pathName }}

    {{- $controllerName := concat $nameFromPath "Controller" | toTitle}}
    {{- $pathData := index $rootData "PathData" }}
    {{- $pathName := index $rootData "PathName" }}
    func (c * {{ $controllerName }} ) Mappings() []web.Mapping {
        return []web.Mapping{
        {{- with $pathData }}
            {{- range $opName, $opData := pathOperations . }}
                {{- $operation :=  concat $nameFromPath $opName | operation $opData }}
            rest.
                New("{{ mappingName $pathName $opName }}").
                {{$opName}}("{{ mappingPath $pathName }}").
                EndpointFunc(c.{{toTitle $operation.Name}}).
                Build(),
            {{- end }}
        {{- end }}
        }
    }
{{- end }}

{{ define "controllerFunctions" }}
    {{- $rootData := index . 0 }}
    {{- $pathData := index $rootData "PathData" }}

    {{- $pathName := index $rootData "PathName" }}
    {{- $nameFromPath := defaultNameFromPath $pathName }}

    {{- $controllerName := concat $nameFromPath "Controller" | toTitle}}

    {{- range $opName, $opData := pathOperations $pathData }}
        {{- $operation := concat $nameFromPath $opName | operation $opData }}

        {{ $defaultResponse := "" }}
        {{ range $respName, $respData := $operation.Data.Responses }}
            {{ $defaultResponse = $respName}}
            {{- break -}}
        {{- end }}
        {{- $defaultResponseIs200 := eq $defaultResponse "200"}}
        {{- $noResponses := not $operation.Data.Responses }}
        {{- $hideStatus := or $noResponses $defaultResponseIs200 }}
        func (c * {{ $controllerName }}) {{ template "controllerFuncArguments" args $operation}} {{template "controllerFuncReturnType" args $hideStatus $operation}} {
            return {{if not $hideStatus}} 501, {{- end }}{{- template "responseBodyDefaultValue" args $hideStatus $operation}}, nil
        }

    {{- end }}
{{- end }}

{{ define "controllerFuncArguments" }}
    {{- $operation := index . 0 }}
    {{- $requestStruct := $operation.RequestStruct structRegistry}}
    {{- $type := "" }}
    {{- $import := "" }}
    {{- if $requestStruct }}
        {{- $type = toTitle $requestStruct.Struct }}
        {{- $import = $requestStruct.ImportAlias }}
    {{- end }}

    {{- toTitle $operation.Name -}}(ctx context.Context{{ if $type }}, req {{basePath $import}}.{{$type}}{{- end}})
{{- end }}

{{ define "controllerFuncReturnType" }}
    {{- $hideStatus := index . 0 -}}
    {{- $operation := index . 1 }}

    {{- $importPrefix := "" }}
    {{- $type := "" }}
    {{- $responseStruct := $operation.ResponseStruct structRegistry -}}
    {{- if $responseStruct }}
        {{- $importPrefix = $responseStruct.ImportAlias }}
        {{- $type = toTitle $responseStruct.Struct }}
    {{- end }}

    {{- $pointer := "" }}
    {{- if $importPrefix }}
        {{- $pointer = "*" }}
    {{- else }}
        {{- /*If this is an array of an object, add a pointer to the array, otherwise just return an array of the type */ -}}
        {{- range $i, $content := $operation.AllResponseContent }}
            {{- $isNotObject := ne $content.Schema.Value.Type "object" }}
            {{- $isNotArray := ne $content.Schema.Value.Type "array" }}
            {{- $isBaseType := and $isNotObject $isNotArray }}
            {{- if $isBaseType}}
                {{- $type = schemaToText $content.Schema "" "" }}
            {{- end }}
            {{- break }}
        {{- end }}
    {{- end -}}

({{if not $hideStatus}} int, {{- end }}{{$pointer}}{{with $importPrefix}}{{.}}.{{ end }}{{with $type}}{{.}}{{else}}interface{}{{end}}, error)
{{- end }}

{{ define "responseBodyDefaultValue" -}}
    {{- $hideStatus := index . 0 -}}
    {{- $operation := index . 1 }}

    {{- $importPrefix := "" }}
    {{- $type := "" }}
    {{- $responseStruct := $operation.StructForMessage "Response" structRegistry -}}
    {{- if $responseStruct }}
        {{- $importPrefix = $responseStruct.ImportAlias }}
        {{- $type = toTitle $responseStruct.Struct }}
    {{- end -}}

    {{ if $importPrefix -}}
        &{{$importPrefix}}.{{$type}}{}
    {{- else -}}
       {{- range $i, $content := $operation.AllResponseContent }}
            {{- $type = $content.Schema.Value.Type }}
            {{- break }}
        {{- end }}
        {{- $defaultValue := "nil" }}
        {{- if eq $type "string" -}}
            {{- $defaultValue = "\"\"" }}
        {{- else if eq $type "integer" }}
            {{- $defaultValue = "0" }}
        {{- else if eq $type "number" }}
            {{- $defaultValue = "0.0" }}
        {{- else if eq $type "boolean" }}
            {{- $defaultValue = "false" }}
        {{- end }}

        {{- $defaultValue -}}
    {{- end -}}
{{- end }}